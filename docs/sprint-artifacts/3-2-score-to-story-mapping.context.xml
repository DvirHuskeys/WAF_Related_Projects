<story-context id="{bmad_folder}/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>2</storyId>
    <title>Score-to-Story Mapping</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-30</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-2-score-to-story-mapping.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>As AE Alex</asA>
    <iWant>I want persona prompts tailored to score ranges (drift, downtime, attack surface)</iWant>
    <soThat></soThat>
    <tasks>      <![CDATA[
      - [ ] Hook configuration (AC: 1–2,5)  
  - [ ] Create `config/persona_hooks.yaml` or similar file defining thresholds + copy.  
  - [ ] Load config at runtime and cache.  
- [ ] Persona service integration (AC: 1–3)  
  - [ ] Update `scoring.build_story()` (or new helper) to select hooks based on scores.  
  - [ ] Ensure persona API returns `hooks` array.  
- [ ] UI wiring (AC: 4)  
  - [ ] Persona cards show top hook + badges referencing others.  
  - [ ] Copy button pulls from `story_prompt`.  
- [ ] Documentation (AC: 5)  
  - [ ] Add section in README describing how to edit hooks/thresholds.
      ]]></tasks>
  </story>

  <acceptanceCriteria>      <![CDATA[
      1. Given scoring thresholds are defined (e.g., drift >0.7), when persona service builds a prompt it uses the matching hook text (“Lead with configuration coherence”) from a central configuration file.
2. Hooks are customizable per persona (AE Alex, CISO Cassandra, Platform Winston) and stored in a data-driven structure (YAML/JSON or Python dict).
3. Persona API response includes both a single `story_prompt` (string) and structured `hooks` array (each with `title`, `description`, `score_reason`).
4. Streamlit persona cards display the primary hook plus badges for other applicable hooks; copy button includes the top hook.
5. README or config file documents how to adjust thresholds and hook text.
      ]]></acceptanceCriteria>

  <artifacts>
    <docs>      <doc path="docs/sprint-artifacts/3-2-score-to-story-mapping.md" title="Score-to-Story Mapping" section="Story Draft" snippet="As AE Alex, I want persona prompts tailored to score ranges (drift, downtime, attack surface), so I can lead every outreach with the most relevant pain story." />
      <doc path="docs/epics.md" title="WAF Security - Epic Breakdown" section="Story 3.2" snippet="As AE Alex, I want story hooks tailored to score ranges so I can open with the most relevant pain. **Acceptance Criteria** • **Given** scoring config defines thresholds • **When** a domain crosses high drift or downtime thresholds • **Then** persona prompt includes the recommended hook text (“Lead with configuration coherence”) with copy-ready formatting…" />
      <doc path="docs/prd.md" title="Product Requirements Document" section="Executive Summary" snippet="WAF Security establishes a local-first “insight spine” that combines WAFtotal (vendor-agnostic managed-rule transparency) with GTM Radar (domain fingerprinting + storytelling) so every security, architecture, and GTM conversation starts with evidence instead of guesswork. By harvesting domain signals, normalizing Cloudflare/AWS/Akamai rule packs, and…" />
      <doc path="docs/architecture.md" title="Architecture Specification" section="Project Context &amp; Goals" snippet="- **Deployment Reality:** Local-first sandbox meant to run entirely on a lone laptop (Streamlit UI, FastAPI services, DuckDB file storage). No cloud infra, no Postgres/React rewrite—lightweight scripts + HTML artifacts are sufficient so iteration stays fast. - **Primary Outcomes:** 1. Fingerprint domains (CLI + FastAPI) and persist results in DuckDB. 2.…" />
      <doc path="docs/product-brief-WAF Security-2025-11-30.md" title="Product Brief" section="Executive Summary" snippet="WAF Security is building an internal “insight spine” that fuses two sibling ideas—**WAFtotal**, a vendor-agnostic managed-rule transparency experience, and **GTM Radar**, a domain fingerprinting + storytelling engine for sales and marketing teams. Together they deliver three promises: (1) decode any prospect’s WAF/CDN posture in minutes, (2) expose…" />
      <doc path="docs/research-market-2025-11-30.md" title="Market/Domain Research" section="Executive Summary" snippet="- The global web application firewall (WAF) market is scaling aggressively: SNS Insider pegs it at **USD 6.35 B in 2023 with a path to USD 28.6 B by 2032 (18.2% CAGR)**, while ResearchAndMarkets estimates **USD 6.22 B in 2024 growing to USD 19.2 B by 2033 (13.3% CAGR)**, giving us a triangulated TAM envelope of USD 19–29 B within a decade. - [Source: SNS…" /></docs>
    <code>      <code path="backend/services/persona.py" kind="service" symbol="generate_persona_view" lines="28-48" reason="Persona payload builder powering API/UI flows in Epic 3." />
      <code path="backend/services/scoring.py" kind="service" symbol="derive_scores" lines="6-18" reason="Derives persona-ready metrics for story mapping." />
      <code path="ui/app.py" kind="ui" symbol="Persona card surface" lines="1-56" reason="Renders persona selectors and hooks required by Epic 3 UI work." /></code>
    <dependencies>      <dependency name="fastapi" version="0.115.2" scope="api" />
      <dependency name="duckdb" version="1.1.3" scope="storage" />
      <dependency name="streamlit" version="1.40.1" scope="ui" /></dependencies>
  </artifacts>

  <constraints>      <![CDATA[
      - Hooks should match UX copy guidelines; keep language short and action-oriented.  
- Consider weighting scores if multiple thresholds trigger simultaneously (e.g., drift high + downtime medium).  
- Provide tests verifying config parsing + deterministic output.

### Project Structure Notes

- Place config under `config/` and expose via `backend/services/hooks.py`.  
- Ensure changes don’t require app restart (reload on change optional).

### References

- [Source: docs/epics.md#story-32-score-to-story-mapping]  
- [Source: docs/prd.md#functional-requirements FR6, FR23]
      ]]></constraints>
  <interfaces>      <interface name="GET /persona/{persona_id}/{domain}" kind="REST endpoint" signature="GET /persona/{persona_id}/{domain}" path="backend/main.py" /></interfaces>
  <tests>
    <standards>      <![CDATA[
      - [x] domain_enrich.py run Command: `python scripts/domain_enrich.py data/samples/domains.csv` Result: Generated four enriched records in DuckDB, offline heuristics used. - [x] rule_sync/run.py Command: `python scripts/rule_sync/run.py cloudflare --source data/rules/cloudflare_sample.json` Result: Loaded two sample managed rules. - [x] API schema test…
      ]]></standards>
    <locations>      <![CDATA[
      tests/, scripts/, ui/
      ]]></locations>
    <ideas>      <![CDATA[
      AC1: Verify Given scoring thresholds are defined (e.g., drift >0.7), when persona service builds a prompt it uses the matching hook text (“Lead with configuration coherence”) from a central configuration file.; AC2: Verify Hooks are customizable per persona (AE Alex, CISO Cassandra, Platform Winston) and stored in a data-driven structure (YAML/JSON or Python dict).; AC3: Verify Persona API response includes both a single `story_prompt` (string) and structured `hooks` array (each with `title`, `description`, `score_reason`).; AC4: Verify Streamlit persona cards display the primary hook plus badges for other applicable hooks; copy button includes the top hook.; AC5: Verify README or config file documents how to adjust thresholds and hook text.
      ]]></ideas>
  </tests>
</story-context>
