<story-context id="{bmad_folder}/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>2</storyId>
    <title>Role-Based Access Enforcement</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-30</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/6-2-role-based-access.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>As security leads</asA>
    <iWant></iWant>
    <soThat></soThat>
    <tasks>      <![CDATA[
      - [ ] Role config helper (AC: 5)  
  - [ ] Create `config/roles.yaml` and loader returning permissions per role.  
- [ ] Streamlit enforcement (AC: 1–3)  
  - [ ] Add `require_role("admin")` decorator/helper to gate pages.  
  - [ ] Disable persona/export/annotation buttons for insufficient roles with tooltip.  
- [ ] API enforcement (AC: 2 & 4)  
  - [ ] Persona/export endpoints verify role before executing; log denials.  
- [ ] Logging (AC: 4)  
  - [ ] Extend `activity_log` to include access_denied entries.  
- [ ] Docs (AC: 5)  
  - [ ] README instructions for setting `ROLE` env and editing role map.
      ]]></tasks>
  </story>

  <acceptanceCriteria>      <![CDATA[
      1. Admin-only sections (Adapter panel, job logs) are hidden unless `ROLE=admin`; unauthorized users see “restricted” messaging.
2. Persona API, exports, annotations, and copy buttons require roles `admin`, `security`, or `gtm`. `viewer` role can only read the Radar table.
3. Buttons that a user cannot access are disabled with tooltips explaining why; keyboard focus respects disabled state.
4. Access denials are logged to `activity_log` with timestamp, role, action, and target.
5. Role mappings live in `config/roles.yaml` (or `.env`), documented in README, and easily extendable.
      ]]></acceptanceCriteria>

  <artifacts>
    <docs>      <doc path="docs/sprint-artifacts/6-2-role-based-access.md" title="Role-Based Access Enforcement" section="Story Draft" snippet="As security leads, we want basic role-based access controls across the UI and exports, so only authorized users can touch sensitive intel, admin settings, or annotations." />
      <doc path="docs/epics.md" title="WAF Security - Epic Breakdown" section="Story 6.2" snippet="As security leads, we want RBAC so only authorized users can view sensitive targets or run reports. **Acceptance Criteria** • **Given** `roles.yaml` defines Admin/Security/GTM/Viewer • **When** the app loads • **Then** unauthorized roles cannot see admin tab, annotations, or sensitive exports; persona/report endpoints validate role before returning data…" />
      <doc path="docs/prd.md" title="Product Requirements Document" section="Executive Summary" snippet="WAF Security establishes a local-first “insight spine” that combines WAFtotal (vendor-agnostic managed-rule transparency) with GTM Radar (domain fingerprinting + storytelling) so every security, architecture, and GTM conversation starts with evidence instead of guesswork. By harvesting domain signals, normalizing Cloudflare/AWS/Akamai rule packs, and…" />
      <doc path="docs/architecture.md" title="Architecture Specification" section="Project Context &amp; Goals" snippet="- **Deployment Reality:** Local-first sandbox meant to run entirely on a lone laptop (Streamlit UI, FastAPI services, DuckDB file storage). No cloud infra, no Postgres/React rewrite—lightweight scripts + HTML artifacts are sufficient so iteration stays fast. - **Primary Outcomes:** 1. Fingerprint domains (CLI + FastAPI) and persist results in DuckDB. 2.…" />
      <doc path="docs/product-brief-WAF Security-2025-11-30.md" title="Product Brief" section="Executive Summary" snippet="WAF Security is building an internal “insight spine” that fuses two sibling ideas—**WAFtotal**, a vendor-agnostic managed-rule transparency experience, and **GTM Radar**, a domain fingerprinting + storytelling engine for sales and marketing teams. Together they deliver three promises: (1) decode any prospect’s WAF/CDN posture in minutes, (2) expose…" />
      <doc path="docs/research-market-2025-11-30.md" title="Market/Domain Research" section="Executive Summary" snippet="- The global web application firewall (WAF) market is scaling aggressively: SNS Insider pegs it at **USD 6.35 B in 2023 with a path to USD 28.6 B by 2032 (18.2% CAGR)**, while ResearchAndMarkets estimates **USD 6.22 B in 2024 growing to USD 19.2 B by 2033 (13.3% CAGR)**, giving us a triangulated TAM envelope of USD 19–29 B within a decade. - [Source: SNS…" /></docs>
    <code>      <code path="backend/main.py" kind="api" symbol="FastAPI router" lines="1-30" reason="Base API endpoints securing admin/governance capabilities." />
      <code path="backend/services/storage.py" kind="service" symbol="audit tables" lines="18-47" reason="Holds configuration/audit data leveraged by Epic 6." />
      <code path="scripts/rule_sync/run.py" kind="cli" symbol="adapter controller" lines="1-120" reason="Adapter orchestration referenced by configuration/admin stories." /></code>
    <dependencies>      <dependency name="fastapi" version="0.115.2" scope="api" />
      <dependency name="uvicorn" version="0.30.6" scope="api" />
      <dependency name="duckdb" version="1.1.3" scope="storage" /></dependencies>
  </artifacts>

  <constraints>      <![CDATA[
      - Covers PRD FR16 + FR17.  
- Still simple env-based auth but keeps demos safe; later we can plug in real identity provider.  
- Consider default role `admin` for local dev but encourage setting `ROLE=viewer` for read-only sessions.

### Project Structure Notes

- Put helpers in `backend/services/auth.py`; import from UI and API modules.  
- Ensure `config/roles.yaml` is gitignored, with sample file committed.

### References

- [Source: docs/epics.md#story-62-role-based-access-enforcement]  
- [Source: docs/prd.md#functional-requirements FR16]
      ]]></constraints>
  <interfaces>      <interface name="FastAPI admin endpoints" kind="REST endpoint" signature="GET /personas" path="backend/main.py" /></interfaces>
  <tests>
    <standards>      <![CDATA[
      - [x] domain_enrich.py run Command: `python scripts/domain_enrich.py data/samples/domains.csv` Result: Generated four enriched records in DuckDB, offline heuristics used. - [x] rule_sync/run.py Command: `python scripts/rule_sync/run.py cloudflare --source data/rules/cloudflare_sample.json` Result: Loaded two sample managed rules. - [x] API schema test…
      ]]></standards>
    <locations>      <![CDATA[
      tests/, scripts/, ui/
      ]]></locations>
    <ideas>      <![CDATA[
      AC1: Verify Admin-only sections (Adapter panel, job logs) are hidden unless `ROLE=admin`; unauthorized users see “restricted” messaging.; AC2: Verify Persona API, exports, annotations, and copy buttons require roles `admin`, `security`, or `gtm`. `viewer` role can only read the Radar table.; AC3: Verify Buttons that a user cannot access are disabled with tooltips explaining why; keyboard focus respects disabled state.; AC4: Verify Access denials are logged to `activity_log` with timestamp, role, action, and target.; AC5: Verify Role mappings live in `config/roles.yaml` (or `.env`), documented in README, and easily extendable.
      ]]></ideas>
  </tests>
</story-context>
